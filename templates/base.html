<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}üìä Electronics Dashboard{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
</head>
<body>
    <header class="header">
        <h2>üìä Electronics Dashboard</h2>
        <form method="POST" action="/" class="control-bar" onsubmit="showLoading()">
            <label for="grouping_dimension">Group By:</label>
            <select name="grouping_dimension">
                {% for group in group_options %}
                    <option value="{{ group }}" {% if group == selected_group %}selected{% endif %}>{{ group }}</option>
                {% endfor %}
            </select>

            <label for="product_label">Product Filter:</label>
            <input type="text" name="product_label" placeholder="e.g. charger" value="{{ product_label }}" />

            <button type="submit">üîç Update</button>
        </form>
    </header>

    <main>
        <section class="dashboard-grid">
            {% for metric, data in chart_data.items() %}
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>{{ data_scope }} ‚Ä¢ {{ metric.replace('_', ' ').title() }}</h3>
                        <select class="chart-type-selector" data-metric="{{ metric }}">
                            {% for chart_type in chart_types %}
                                <option value="{{ chart_type }}" {% if chart_type == plot_config[metric] %}selected{% endif %}>{{ chart_type.title() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <canvas id="{{ metric }}-chart"></canvas>
                </div>
            {% endfor %}
        </section>

        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>&copy; {{ current_year }} Batch Dashboard by Rvc</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    const chartData = {{ chart_data | tojson }};
    const chartTypes = {{ plot_config | tojson }};
    const chartInstances = {};

    function generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            const hue = (i * 360 / count) % 360;
            colors.push(`hsl(${hue}, 70%, 60%)`);
        }
        return colors;
    }

    function renderChart(metric) {
        const canvas = document.getElementById(`${metric}-chart`);
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        const type = chartTypes[metric];
        const labels = chartData[metric].x;
        const values = chartData[metric].y;

        const colorful = ["pie", "doughnut", "polarArea"];
        const backgroundColors = colorful.includes(type) ? generateColors(values.length) : "rgba(100, 149, 237, 0.6)";
        const borderColors = colorful.includes(type) ? backgroundColors : "rgba(100, 149, 237, 1)";

        const config = {
            type: type === "area" ? "line" : type,
            data: {
                labels: labels,
                datasets: [{
                    label: metric.replace("_", " ").toUpperCase(),
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    fill: type === "area"
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        };

        if (chartInstances[metric]) {
            chartInstances[metric].destroy();
        }

        chartInstances[metric] = new Chart(ctx, config);
    }

    function renderAllCharts() {
        Object.keys(chartData).forEach(renderChart);
    }

    function updateChartType(metric, newType) {
        chartTypes[metric] = newType;
        renderChart(metric);
    }

    document.addEventListener("DOMContentLoaded", () => {
        renderAllCharts();

        document.querySelectorAll(".chart-type-selector").forEach(selector => {
            selector.addEventListener("change", (e) => {
                const metric = e.target.dataset.metric;
                const newType = e.target.value;
                updateChartType(metric, newType);
            });
        });
    });
    </script>
</body>
</html>
